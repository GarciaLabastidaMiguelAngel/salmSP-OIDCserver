server:
  port: 8080

spring:
  # Redis Configuration (MANTENER para Spring Session)
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    timeout: 2000ms
    jedis:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms

  # Spring Session with Redis (MANTENER - NO TOCAR)
  session:
    store-type: redis
    redis:
      namespace: spring:session
      flush-mode: on_save
    timeout: 1800 # 30 minutes in seconds

  # H2 Database (para OAuth2AuthorizationService JDBC Ãºnicamente)
  datasource:
    url: jdbc:h2:mem:authdb;MODE=Oracle;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driverClassName: org.h2.Driver
    username: sa
    password:
  
  # H2 Console (for development/debugging)
  h2:
    console:
      enabled: true
      path: /h2-console
  
  # SQL Initialization
  sql:
    init:
      mode: always

logging:
  level:
    root: INFO
    org.springframework.security: DEBUG
    org.springframework.security.saml2: TRACE
    org.springframework.security.web: DEBUG
    org.springframework.security.oauth2: DEBUG
    org.springframework.security.oauth2.server.authorization: TRACE
    org.opensaml: DEBUG
    com.authserver: DEBUG

# Application-specific configuration
app:
  # Session Cookie Configuration
  # Controls how the session cookie (SESSION/JSESSIONID) is emitted to the browser.
  # Does NOT affect session storage (Redis remains unchanged).
  session:
    cookie:
      # Cookie name
      name: ${SESSION_COOKIE_NAME:SESSION}
      
      # Cookie domain (empty = not set, scoped to current domain)
      # Example: ".example.com" for subdomain sharing
      domain: ${SESSION_COOKIE_DOMAIN:}
      
      # Cookie path
      path: ${SESSION_COOKIE_PATH:/}
      
      # HttpOnly flag (prevents JavaScript access)
      http-only: ${SESSION_COOKIE_HTTPONLY:true}
      
      # Secure flag (requires HTTPS)
      # Production: true (HTTPS required)
      # Local dev: false (allows HTTP)
      secure: ${SESSION_COOKIE_SECURE:true}
      
      # SameSite attribute (Lax, Strict, None)
      # - Lax: Allows cross-site top-level navigation (recommended)
      # - Strict: No cross-site requests
      # - None: Allows all cross-site (requires secure=true)
      same-site: ${SESSION_COOKIE_SAMESITE:Lax}
      
      # Cookie max-age in seconds (empty = session cookie)
      # Session cookie: expires when browser closes
      # Persistent cookie: set a positive value (e.g., 86400 for 24 hours)
      max-age: ${SESSION_COOKIE_MAXAGE:}
      
      # Enable remember-me behavior (requires max-age to be set)
      remember-me: ${SESSION_COOKIE_REMEMBERME:false}

# OIDC Authorization Server Configuration (JDBC-backed with H2, Properties-based clients)
oidc:
  issuer: ${OIDC_ISSUER:http://localhost:8080}
  
  # OAuth2 Clients (loaded from properties, NOT from database)
  clients:
   
    # Example client: example-client (for testing)
    - client-id: example-client
      client-secret: ${EXAMPLE_CLIENT_SECRET:{noop}example-secret}
      client-name: Example Client
      client-auth-methods: [client_secret_basic, client_secret_post]
      grant-types: [authorization_code, refresh_token]
      redirect-uris:
        - http://localhost:8081/callback
      post-logout-redirect-uris:
        - http://localhost:8081/logout-callback
        - http://localhost:8081/
      scopes: [openid, profile, email]
      require-pkce: false
      access-token-format: jwt
      access-token-ttl: PT1H
      refresh-token-ttl: P7D
      reuse-refresh-tokens: false
    
    # Gateway introspection client: gateway-introspect
    - client-id: gateway-introspect
      client-secret: ${GATEWAY_CLIENT_SECRET:{noop}changeit}
      client-name: Gateway Introspection Client
      client-auth-methods: [client_secret_basic]
      grant-types: [client_credentials]
      scopes: [introspect]
      require-pkce: false
      access-token-format: jwt
      access-token-ttl: PT1H
      refresh-token-ttl: P7D
      reuse-refresh-tokens: false

# SAML2 Service Provider (SP)
saml:
  keystore:
    location: ${SAML_KEYSTORE_LOCATION:classpath:keystore/saml-keystore.p12}
    password: ${SAML_KEYSTORE_PASSWORD:changeit}
    alias: ${SAML_KEYSTORE_ALIAS:saml}
    key-password: ${SAML_KEY_PASSWORD:changeit}
  
  # Identity Provider "bet" - Local Mock IdP
  idp:
    entity-id: ${SAML_IDP_ENTITY_ID:BET}
    sso-url: ${SAML_IDP_SSO_URL:http://localhost:8089}
    verification-cert-location: ${SAML_IDP_CERT_LOCATION:file:/Users/miguel/Documents/FIFO/oauthserver-oidc-server/tools/idp-mock/nginx/certs/idp.crt.pem}
  
  # Service Provider external URLs (for Kubernetes/Ingress deployments)
  # REQUIRED: Set external-base-url to your public domain (e.g., https://login.example.com)
  sp:
    external-base-url: ${SAML_SP_EXTERNAL_BASE_URL:http://localhost:8080}
    registration-id: ${SAML_SP_REGISTRATION_ID:bet}
    entity-id: ${SAML_SP_ENTITY_ID:}  # Optional; auto-generated from external-base-url + metadata-path if blank
    
    # URL paths (supports {registrationId} placeholder)
    metadata-path: ${SAML_SP_METADATA_PATH:/saml2/service-provider-metadata/{registrationId}}
    acs-path: ${SAML_SP_ACS_PATH:/login/saml2/sso/{registrationId}}
    slo-request-path: ${SAML_SP_SLO_REQUEST_PATH:/logout/saml2/slo}
    slo-response-path: ${SAML_SP_SLO_RESPONSE_PATH:/logout/saml2/slo}
    
    # SAML Bindings: POST or REDIRECT
    acs-binding: ${SAML_SP_ACS_BINDING:POST}
    sso-binding: ${SAML_SP_SSO_BINDING:POST}
  
  # AuthnRequest Debug (dev/preprod ONLY - hard-blocked in prod)
  debug-authn-request:
    enabled: true  # ALWAYS enabled for now - shows complete AuthnRequest XML in logs
    pretty-print: true  # Formatted XML for readability
